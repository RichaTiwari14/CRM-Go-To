[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-29 15:52:17.035701",
  "module": "CRM-Go-To",
  "name": "Auto-Create Client from Lead",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "CRM Lead",
  "script": "if doc.lead_stage == \"Converted to Deal\":\r\n\r\n    existing = frappe.db.get_value(\r\n        \"Client Master\",\r\n        {\"source_lead\": doc.name}\r\n    )\r\n\r\n    if not existing:\r\n\r\n        client = frappe.new_doc(\"Client Master\")\r\n\r\n        client.client_name = doc.lead_name\r\n        client.client_type = \"Company\" if doc.is_company else \"Individual\"\r\n        client.source_lead = doc.name\r\n        client.account_status = \"Onboarding\"\r\n\r\n        client.primary_email = doc.email\r\n        client.primary_phone = doc.phone\r\n        client.first_name = doc.first_name\r\n        client.last_name = doc.last_name\r\n        client.company_name = doc.company_name\r\n\r\n        client.industry = doc.get(\"industry\")\r\n        client.region = doc.get(\"region\")\r\n        client.account_manager = doc.lead_owner\r\n        client.source = doc.lead_source\r\n\r\n        # -------- Create Primary Contact Row ----------\r\n        if doc.first_name or doc.last_name or doc.email:\r\n            client.append(\"client_contact\", {\r\n                \"contact_name\": (doc.first_name or \"\") + \" \" + (doc.last_name or \"\"),\r\n                \"email\": doc.email,\r\n                \"phone\": doc.phone,\r\n                \"is_primary\": 1\r\n            })\r\n\r\n        client.insert(ignore_permissions=True)\r\n        # --- Timeline Log on Lead ---\r\n        frappe.get_doc(\"CRM Lead\", doc.name).add_comment(\r\n            \"Info\",\r\n            f\"Lead converted to Client ➜ <b>{client.name}</b>\"\r\n        )\r\n        \r\n        # --- Timeline Log on Client ---\r\n        client.add_comment(\r\n            \"Info\",\r\n            f\"Created from Lead ➜ <b>{doc.name}</b>\"\r\n        )\r\n\r\n\r\n        doc.client_created = client.name\r\n        frappe.msgprint(\"Client created with primary contact ✔\")\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-29 16:57:12.538224",
  "module": "CRM-Go-To",
  "name": "Add Contract Validation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Client Master",
  "script": "# Validate Client Contracts\r\nfor c in (doc.client_contract or []):\r\n    \r\n    # Validate date range\r\n    if c.start_date and c.end_date and c.end_date < c.start_date:\r\n        frappe.throw(\"End Date cannot be before Start Date in Contract Row\")\r\n\r\n    # Prevent multiple active retainers\r\n    if c.status == \"Active\":\r\n        active_count = sum(1 for x in doc.client_contract if x.status == \"Active\")\r\n        if active_count > 1:\r\n            frappe.throw(\"Only one Active contract is allowed at a time\")\r\nif any(c.status == \"Active\" for c in (doc.client_contract or [])):\r\n    doc.account_status = \"Active\"\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Hourly",
  "modified": "2025-12-29 17:49:31.747376",
  "module": "CRM-Go-To",
  "name": "SLA Scheduler Event",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "import frappe\r\nfrom frappe.utils import now_datetime\r\n\r\nleads = frappe.get_all(\r\n    \"CRM Lead\",\r\n    filters={\"response_delay_risk\": 1, \"status\": \"Open\"},\r\n    fields=[\"name\", \"lead_owner\", \"expected_response_time\"]\r\n)\r\n\r\nfor l in leads:\r\n    if not l.lead_owner:\r\n        continue\r\n\r\n    frappe.sendmail(\r\n        recipients=l.lead_owner,\r\n        subject=\"⚠ SLA Breach Risk — Lead Reminder\",\r\n        message=f\"\"\"\r\n        Lead <b>{l.name}</b> is approaching SLA breach.<br>\r\n        Expected Response: <b>{l.expected_response_time}</b><br>\r\n        Please take action now.\r\n        \"\"\"\r\n    )\r\n",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Daily",
  "modified": "2025-12-29 17:57:08.941495",
  "module": "CRM-Go-To",
  "name": "Detect Idle/At-Risk Leads",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "import frappe\r\nfrom frappe.utils import now_datetime, add_days, get_datetime\r\n\r\ntoday = get_datetime(now_datetime())\r\n\r\nleads = frappe.get_all(\r\n    \"CRM Lead\",\r\n    filters={\"status\": \"Open\"},\r\n    fields=[\"name\", \"lead_owner\", \"last_follow_up\", \"next_follow_up\"]\r\n)\r\n\r\nfor l in leads:\r\n    last = get_datetime(l.last_follow_up) if l.last_follow_up else None\r\n    next_due = get_datetime(l.next_follow_up) if l.next_follow_up else None\r\n\r\n    # No follow-up yet → mark Idle\r\n    if not last:\r\n        frappe.db.set_value(\"CRM Lead\", l.name, \"inactivity_status\", \"Idle\")\r\n        continue\r\n\r\n    # If overdue → At-Risk\r\n    if next_due and next_due < today:\r\n        frappe.db.set_value(\"CRM Lead\", l.name, \"inactivity_status\", \"At-Risk\")\r\n\r\n        # Send alert\r\n        if l.lead_owner:\r\n            frappe.sendmail(\r\n                recipients=l.lead_owner,\r\n                subject=\"⚠ Lead Follow-up Overdue\",\r\n                message=f\"Lead <b>{l.name}</b> follow-up is overdue. Please take action.\"\r\n            )\r\n\r\n    # Otherwise → Active\r\n    else:\r\n        frappe.db.set_value(\"CRM Lead\", l.name, \"inactivity_status\", \"Active\")\r\n",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-29 23:03:13.322810",
  "module": "CRM-Go-To",
  "name": "UTM Mapping Logic",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "CRM Lead",
  "script": "# ---- UTM Attribution Mapping ----\r\n\r\n# Normalize input\r\nsrc = (doc.utm_source or \"\").lower().strip()\r\nmed = (doc.utm_medium or \"\").lower().strip()\r\ncamp = (doc.utm_campaign or \"\").lower().strip()\r\n\r\n# Channel mapping rules\r\nchannel_map = {\r\n    \"google\": \"Paid Search\",\r\n    \"gads\": \"Paid Search\",\r\n    \"sem\": \"Paid Search\",\r\n\r\n    \"facebook\": \"Paid Social\",\r\n    \"fb\": \"Paid Social\",\r\n    \"instagram\": \"Paid Social\",\r\n    \"ig\": \"Paid Social\",\r\n    \"meta\": \"Paid Social\",\r\n    \"linkedin\": \"Paid Social\",\r\n    \"youtube\": \"Video Campaign\",\r\n\r\n    \"email\": \"Email Campaign\",\r\n    \"newsletter\": \"Email Campaign\",\r\n\r\n    \"referral\": \"Referral / Partner\",\r\n    \"whatsapp\": \"Referral / Partner\",\r\n\r\n    \"organic\": \"Organic Search\",\r\n    \"seo\": \"Organic Search\",\r\n\r\n    \"direct\": \"Direct Traffic\"\r\n}\r\n\r\n# Default value\r\ndoc.attribution_channel = \"Other\"\r\n\r\nfor key, val in channel_map.items():\r\n    if key in src or key in med:\r\n        doc.attribution_channel = val\r\n        break\r\n\r\n\r\n# ---- Build Clean Marketing Source Label ----\r\nparts = []\r\n\r\nif doc.utm_source:\r\n    parts.append(doc.utm_source)\r\n\r\nif doc.utm_medium:\r\n    parts.append(doc.utm_medium)\r\n\r\nif doc.utm_campaign:\r\n    parts.append(doc.utm_campaign)\r\n\r\ndoc.marketing_source = \" | \".join(parts)\r\n\r\nscore_map = {\r\n    \"Referral / Partner\": 9,\r\n    \"Paid Search\": 8,\r\n    \"Paid Social\": 6,\r\n    \"Email Campaign\": 5,\r\n    \"Organic Search\": 5,\r\n    \"Direct Traffic\": 4,\r\n    \"Other\": 3\r\n}\r\n\r\ndoc.lead_score = score_map.get(doc.attribution_channel, 3)\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-30 09:04:35.174295",
  "module": "CRM-Go-To",
  "name": "Lead Validation Script",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "CRM Lead",
  "script": "# ---- Conversion Validation + Pipeline Exit ----\r\n\r\nif doc.lead_stage == \"Converted to Deal\":\r\n\r\n    missing = []\r\n\r\n    # Person / Company validation\r\n    if doc.is_company and not doc.company_name:\r\n        missing.append(\"Company Name\")\r\n\r\n    if not doc.is_company and not doc.first_name:\r\n        missing.append(\"First Name\")\r\n\r\n    # Contact fields\r\n    if not (doc.email or doc.phone):\r\n        missing.append(\"Email or Phone\")\r\n\r\n    # Source & ownership\r\n    if not doc.lead_source:\r\n        missing.append(\"Lead Source\")\r\n\r\n    if not doc.lead_owner:\r\n        missing.append(\"Lead Owner\")\r\n\r\n    # Stop conversion if anything missing\r\n    if missing:\r\n        frappe.throw(\r\n            \"Please complete the following fields before converting to deal:<br><br>\"\r\n            + \"<br>\".join(f\"• {m}\" for m in missing)\r\n        )\r\n\r\n    # ---- Auto-close Lead & remove from pipeline ----\r\n    doc.lead_status = \"Closed\"\r\n    doc.inactivity_status = None\r\n    doc.response_delay_risk = 0\r\n    doc.next_follow_up = None\r\n    doc.expected_response_time = None\r\n",
  "script_type": "DocType Event"
 }
]