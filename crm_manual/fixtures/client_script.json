[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CRM Lead",
  "enabled": 0,
  "modified": "2026-01-13 18:04:38.721213",
  "module": "CRM-Go-To",
  "name": "Auto Create Client Master",
  "script": "frappe.ui.form.on(\"CRM Lead\", {\r\n    refresh(frm) {\r\n        if (frm.doc.client_created) {\r\n            frappe.set_route(\"form\", \"Client Master\", frm.doc.client_created);\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Client Master",
  "enabled": 0,
  "modified": "2026-01-12 07:51:48.490167",
  "module": "CRM-Go-To",
  "name": "Onboarding Client Master fields after conversion",
  "script": "frappe.ui.form.on(\"Client Master\", {\r\n    refresh(frm) {\r\n\r\n        // Fields that should appear only AFTER conversion\r\n        const onboarding_fields = [\r\n            \"account_status\",\r\n            \"engagement_type\",\r\n            \"onboarding_stage\",\r\n            \"start_date\",\r\n            \"region\",\r\n            \"industry\",\r\n            \"client_contact\",       // child table\r\n            \"company_name\",\r\n        ];\r\n\r\n        // Show onboarding UI only when client_created_from_lead\r\n        const is_converted = frm.doc.source_lead ? true : false;\r\n\r\n        onboarding_fields.forEach(f => {\r\n            frm.set_df_property(f, \"hidden\", !is_converted);\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CRM Lead",
  "enabled": 1,
  "modified": "2025-12-29 17:55:34.948875",
  "module": "CRM-Go-To",
  "name": "Auto Update Last Follow-up",
  "script": "frappe.ui.form.on(\"Lead Interaction Log\", {\r\n    notes: function(frm) {\r\n        frm.set_value(\"last_follow_up\", frappe.datetime.now_datetime());\r\n        \r\n        // Suggest next follow-up by default +2 days\r\n        if (!frm.doc.next_follow_up) {\r\n            frm.set_value(\r\n                \"next_follow_up\",\r\n                frappe.datetime.add_days(frappe.datetime.now_date(), 2)\r\n            );\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CRM Lead",
  "enabled": 1,
  "modified": "2026-01-14 12:03:10.955038",
  "module": "CRM-Go-To",
  "name": "form buttons",
  "script": "function hide_tabs_from_ui(frm) {\r\n    const tabs = [\"Call Logs\", \"Prospecting\", \"Quotations\"];\r\n\r\n    if (!frm.page || !frm.page.tabs) return;\r\n\r\n    setTimeout(() => {\r\n        tabs.forEach(tab => {\r\n            try {\r\n                frm.page.tabs\r\n                    .find(`a:contains(\"${tab}\")`)\r\n                    .parent()\r\n                    .hide();\r\n            } catch (e) {\r\n                // silent fail (important for stability)\r\n            }\r\n        });\r\n    }, 0);\r\n}\r\n\r\nfunction show_tabs_in_ui(frm) {\r\n    const tabs = [\"Call Logs\", \"Prospecting\", \"Quotations\"];\r\n\r\n    if (!frm.page || !frm.page.tabs) return;\r\n\r\n    setTimeout(() => {\r\n        tabs.forEach(tab => {\r\n            try {\r\n                frm.page.tabs\r\n                    .find(`a:contains(\"${tab}\")`)\r\n                    .parent()\r\n                    .show();\r\n            } catch (e) {\r\n                // silent fail\r\n            }\r\n        });\r\n    }, 0);\r\n}\r\n\r\n\r\nfrappe.ui.form.on(\"CRM Lead\", {\r\n\r\n    // ðŸ”‘ IMPORTANT: hide tabs immediately on load\r\n    onload(frm) {\r\n        if (frm.is_new()) {\r\n            hide_tabs_from_ui(frm);\r\n        }\r\n    },\r\n\r\n    refresh(frm) {\r\n\r\n        // company toggle\r\n        frm.toggle_display(\"company_name\", frm.doc.is_company);\r\n\r\n        const advanced_fields = [\r\n            \"utm_source\", \"utm_medium\", \"utm_campaign\",\r\n            \"sla_priority\", \"expected_response_time\",\r\n            \"next_follow_up_date\", \"lead_score\",\r\n            \"lead_health\", \"lead_status\",\r\n            \"organization\", \"job_title\", \"website\",\r\n            \"attribution_channel\", \"marketing_source\",\r\n            \"inactivity_flag\", \"response_delay_risk\",\r\n            \"inactivity_status\", \"last_follow_up\"\r\n        ];\r\n\r\n        if (frm.is_new()) {\r\n            advanced_fields.forEach(f => frm.set_df_property(f, \"hidden\", 1));\r\n            hide_tabs_from_ui(frm);\r\n            return;\r\n        }\r\n\r\n        // after save\r\n        advanced_fields.forEach(f => frm.set_df_property(f, \"hidden\", 0));\r\n        show_tabs_in_ui(frm);\r\n        // ðŸŸ¢ Go To Client\r\n        if (frm.doc.client_created) {\r\n            frm.add_custom_button(\r\n                \"Go To Client\",\r\n                () => {\r\n                    frappe.set_route(\r\n                        \"Form\",\r\n                        \"Client Master\",\r\n                        frm.doc.client_created\r\n                    );\r\n                },\r\n                \"Actions\"\r\n            );\r\n        }\r\n\r\n        // ðŸŸ£ Go To Deal\r\n        if (frm.doc.deal_created) {\r\n            frm.add_custom_button(\r\n                \"Go To Deal\",\r\n                () => {\r\n                    frappe.set_route(\r\n                        \"Form\",\r\n                        \"CRM Deal\",\r\n                        frm.doc.deal_created\r\n                    );\r\n                },\r\n                \"Actions\"\r\n            );\r\n        }\r\n\r\n\r\n        if (frm.doc.lead_stage === \"Converted to Deal\") {\r\n            frm.set_df_property(\"lead_stage\", \"read_only\", 1);\r\n        }\r\n\r\n        render_call_logs(frm);\r\n        render_prospecting(frm);\r\n        render_quotations(frm);\r\n    },\r\n    is_company(frm) {\r\n        frm.toggle_display(\"company_name\", frm.doc.is_company);\r\n    },\r\n\r\n    first_name(frm) {\r\n        set_full_name(frm);\r\n    },\r\n\r\n    last_name(frm) {\r\n        set_full_name(frm);\r\n    }\r\n});\r\n\r\n// ---------------- FULL NAME BUILDER ----------------\r\nfunction set_full_name(frm) {\r\n    let full = frm.doc.first_name || \"\";\r\n    if (frm.doc.last_name) full += \" \" + frm.doc.last_name;\r\n    frm.set_value(\"lead_name\", full.trim());\r\n}\r\n\r\n/* ================= CALL LOGS ================= */\r\nfunction render_call_logs(frm) {\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Call Log Go-To\",\r\n            filters: { linked_lead: frm.doc.name },\r\n            fields: [\"name\", \"call_type\", \"creation\"],\r\n            order_by: \"creation desc\"\r\n        },\r\n        callback(r) {\r\n            const rows = r.message || [];\r\n\r\n            let html = `\r\n                <button class=\"btn btn-sm btn-dark mb-3\"\r\n                    onclick=\"frappe.new_doc('Call Log Go-To', { linked_lead: '${frm.doc.name}' })\">\r\n                    + Add Call Log\r\n                </button>\r\n            `;\r\n\r\n            if (!rows.length) {\r\n                html += `<p class=\"text-muted\">No call logs yet.</p>`;\r\n            }\r\n\r\n            rows.forEach(d => {\r\n                let badge = \"secondary\";\r\n                if (d.call_type === \"Incoming\") badge = \"success\";\r\n                if (d.call_type === \"Outgoing\") badge = \"info\";\r\n\r\n                html += `\r\n                    <div class=\"crm-card\"\r\n                        onclick=\"frappe.set_route('Form','Call Log Go-To','${d.name}')\">\r\n                        <div class=\"d-flex justify-content-between align-items-center\">\r\n                            <div>\r\n                                <div class=\"crm-title\">${d.name}</div>\r\n                                <div class=\"crm-sub\">\r\n                                    ${frappe.datetime.str_to_user(d.creation)}\r\n                                </div>\r\n                            </div>\r\n                            <div class=\"crm-badge ${badge}\">\r\n                                ${d.call_type || \"Unknown\"}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                `;\r\n            });\r\n\r\n            frm.fields_dict.call_logs_html.$wrapper.html(html);\r\n        }\r\n    });\r\n}\r\n\r\n/* ================= PROSPECTING ================= */\r\nfunction render_prospecting(frm) {\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Prospecting\",\r\n            filters: { lead: frm.doc.name },\r\n            fields: [\"name\", \"status\", \"is_latest\", \"revision_no\", \"creation\"],\r\n            order_by: \"revision_no desc\"\r\n        },\r\n        callback(r) {\r\n            const rows = r.message || [];\r\n\r\n            let html = `\r\n                <button class=\"btn btn-sm btn-dark mb-3\"\r\n                    onclick=\"frappe.new_doc('Prospecting', { lead: '${frm.doc.name}' })\">\r\n                    + Create Prospecting\r\n                </button>\r\n            `;\r\n\r\n            if (!rows.length) {\r\n                html += `<p class=\"text-muted\">No prospecting created.</p>`;\r\n            }\r\n\r\n            rows.forEach(d => {\r\n                html += `\r\n                    <div class=\"crm-card\"\r\n                        style=\"${d.is_latest ? 'border-left:4px solid #22c55e;' : ''}\"\r\n                        onclick=\"frappe.set_route('Form','Prospecting','${d.name}')\">\r\n                        <div class=\"d-flex justify-content-between align-items-center\">\r\n                            <div>\r\n                                <div class=\"crm-title\">${d.name}</div>\r\n                                <div class=\"crm-sub\">\r\n                                    Revision ${d.revision_no} â€¢ ${frappe.datetime.str_to_user(d.creation)}\r\n                                </div>\r\n                            </div>\r\n                            <div class=\"crm-badge ${d.is_latest ? 'success' : 'info'}\">\r\n                                ${d.is_latest ? \"Latest\" : \"History\"}\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"mt-2 crm-sub\">\r\n                            Status: <b>${d.status || \"Draft\"}</b>\r\n                        </div>\r\n                    </div>\r\n                `;\r\n            });\r\n\r\n            frm.fields_dict.prospecting_html.$wrapper.html(html);\r\n        }\r\n    });\r\n}\r\n\r\n/* ================= QUOTATIONS ================= */\r\nfunction render_quotations(frm) {\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"CRM Quotation\",\r\n            filters: { lead: frm.doc.name },\r\n            fields: [\"name\", \"estimated_value\", \"workflow_state\", \"creation\"],\r\n            order_by: \"creation desc\"\r\n        },\r\n        callback(r) {\r\n            const rows = r.message || [];\r\n\r\n            let html = `\r\n                <button class=\"btn btn-sm btn-dark mb-3\"\r\n                    onclick=\"frappe.new_doc('CRM Quotation', { lead: '${frm.doc.name}' })\">\r\n                    + Create Quotation\r\n                </button>\r\n            `;\r\n\r\n            if (!rows.length) {\r\n                html += `<p class=\"text-muted\">No quotations yet.</p>`;\r\n            }\r\n\r\n            rows.forEach(d => {\r\n                html += `\r\n                    <div class=\"crm-card\"\r\n                        onclick=\"frappe.set_route('Form','CRM Quotation','${d.name}')\">\r\n                        <div class=\"d-flex justify-content-between\">\r\n                            <div>\r\n                                <div class=\"crm-title\">${d.name}</div>\r\n                                <div class=\"crm-sub\">${frappe.datetime.str_to_user(d.creation)}</div>\r\n                            </div>\r\n                            <div class=\"crm-badge warning\">\r\n                                â‚¹ ${d.estimated_value || 0}\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"mt-2 crm-sub\">\r\n                            Status: <b>${d.workflow_state || \"-\"}</b>\r\n                        </div>\r\n                    </div>\r\n                `;\r\n            });\r\n\r\n            frm.fields_dict.quotations_html.$wrapper.html(html);\r\n        }\r\n    });\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Prospecting",
  "enabled": 1,
  "modified": "2026-01-08 13:49:45.012398",
  "module": "CRM-Go-To",
  "name": "Prospecting",
  "script": "frappe.ui.form.on(\"Prospecting\", {\r\n    refresh(frm) {\r\n\r\n        /* ---------- REVISION HISTORY ---------- */\r\n        if (frm.doc.lead && frm.fields_dict.revision_history) {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"Prospecting\",\r\n                    filters: { lead: frm.doc.lead },\r\n                    fields: [\"name\", \"revision_no\", \"is_latest\"],\r\n                    order_by: \"revision_no desc\"\r\n                },\r\n                callback(r) {\r\n                    let html = \"<ul class='list-unstyled'>\";\r\n                    (r.message || []).forEach(p => {\r\n                        html += `\r\n                            <li style=\"margin-bottom:4px\">\r\n                              <a href=\"/app/prospecting/${p.name}\">\r\n                                Revision ${p.revision_no || 0}\r\n                                ${p.is_latest ? \"<b>(Latest)</b>\" : \"\"}\r\n                              </a>\r\n                            </li>`;\r\n                    });\r\n                    html += \"</ul>\";\r\n                    frm.fields_dict.revision_history.$wrapper.html(html);\r\n                }\r\n            });\r\n        }\r\n\r\n        /* ---------- REVISE BUTTON (ONLY FOR LATEST) ---------- */\r\n        if (!frm.is_new() && frm.doc.is_latest) {\r\n            frm.add_custom_button(\r\n                \"Revise Prospecting\",\r\n                () => {\r\n                    frappe.call({\r\n                        method: \"crm_manual.crm_go_to.doctype.prospecting.api.revise_prospecting\",\r\n                        args: { prospect: frm.doc.name },\r\n                        callback(r) {\r\n                            if (r.message) {\r\n                                frappe.set_route(\"Form\", \"Prospecting\", r.message);\r\n                            }\r\n                        }\r\n                    });\r\n                },\r\n                \"Actions\"\r\n            );\r\n        }\r\n\r\n        /* ---------- OLD VERSIONS READ-ONLY UX ---------- */\r\n        if (!frm.is_new() && !frm.doc.is_latest) {\r\n            frm.disable_save();\r\n            frm.set_intro(\r\n                \"This is an old revision. You cannot edit it.\",\r\n                \"orange\"\r\n            );\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CRM Quotation",
  "enabled": 1,
  "modified": "2026-01-13 17:49:13.636218",
  "module": "CRM-Go-To",
  "name": "Quotation",
  "script": "/* =========================================================\r\n   ðŸ”¢ CALCULATION HELPERS (MUST BE DEFINED FIRST)\r\n========================================================= */\r\n\r\nfunction calculate_totals(frm) {\r\n    let total_qty = 0;\r\n    let total_amount = 0;\r\n\r\n    (frm.doc.table_tgfh || []).forEach(row => {\r\n        total_qty += flt(row.qty);\r\n        total_amount += flt(row.amount);\r\n    });\r\n\r\n    frm.set_value(\"total_qty\", total_qty);\r\n    frm.set_value(\"total_amount\", total_amount);\r\n\r\n    const discount = flt(frm.doc.discount_amount);\r\n    const tax = flt(frm.doc.tax_amount);\r\n\r\n    const net_total = total_amount - discount;\r\n    frm.set_value(\"net_total\", net_total);\r\n    frm.set_value(\"grand_total\", net_total + tax);\r\n}\r\n\r\nfunction calculate_row(frm, cdt, cdn) {\r\n    const row = locals[cdt][cdn];\r\n    row.amount = flt(row.qty) * flt(row.rate);\r\n    frm.refresh_field(\"table_tgfh\");\r\n    calculate_totals(frm);\r\n}\r\n\r\nfunction sync_status_with_docstatus(frm) {\r\n    let status = \"Draft\";\r\n\r\n    if (frm.doc.docstatus === 1) status = \"Submitted\";\r\n    if (frm.doc.docstatus === 2) status = \"Cancelled\";\r\n\r\n    frm.set_value(\"status\", status);\r\n    frm.set_df_property(\"status\", \"read_only\", 1);\r\n}\r\n\r\n\r\n/* =========================================================\r\n   ðŸ“„ CRM QUOTATION MAIN FORM\r\n========================================================= */\r\n\r\nfrappe.ui.form.on(\"CRM Quotation\", {\r\n\r\n    onload(frm) {\r\n        sync_status_with_docstatus(frm);\r\n\r\n        // Auto set party only for NEW quotation\r\n        if (frm.is_new() && frm.doc.lead) {\r\n            frm.set_value(\"quotation_to\", \"CRM Lead\");\r\n            frm.set_value(\"party\", frm.doc.lead);\r\n        }\r\n    },\r\n\r\n    refresh(frm) {\r\n        sync_status_with_docstatus(frm);\r\n\r\n        // ðŸ” REVISION BUTTON\r\n        if (\r\n            !frm.is_new() &&\r\n            frm.doc.is_latest &&\r\n            [\"Rejected\", \"Negotiation (Maybe)\"].includes(frm.doc.workflow_state)\r\n        ) {\r\n            frm.add_custom_button(\"Revise Quotation\", () => {\r\n                frappe.call({\r\n                    method: \"crm_manual.crm_go_to.doctype.crm_quotation.api.revise_quotation\",\r\n                    args: { quotation: frm.doc.name },\r\n                    callback(r) {\r\n                        if (r.message) {\r\n                            frappe.set_route(\"Form\", \"CRM Quotation\", r.message);\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        }\r\n\r\n        calculate_totals(frm);\r\n    },\r\n\r\n    /* =====================================================\r\n       ðŸš€ SEND FOR APPROVAL â†’ LEAD STAGE = QUOTATION SENT\r\n       (SAFE WORKFLOW HOOK â€“ YAHI SAHI JAGAH HAI)\r\n    ===================================================== */\r\n    before_workflow_action(frm) {\r\n        if (\r\n            frm.selected_workflow_action === \"Send for Approval\" &&\r\n            frm.doc.lead\r\n        ) {\r\n            frappe.call({\r\n                method: \"frappe.client.set_value\",\r\n                args: {\r\n                    doctype: \"CRM Lead\",\r\n                    name: frm.doc.lead,\r\n                    fieldname: \"lead_stage\",\r\n                    value: \"Quotation Sent\"\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    /* =====================================================\r\n       ðŸŽ‰ AFTER APPROVAL â†’ CLIENT CREATED POPUP + REDIRECT\r\n    ===================================================== */\r\n    after_workflow_action(frm) {\r\n        if (frm.doc.workflow_state === \"Approved\" && frm.doc.client_created) {\r\n            frappe.msgprint({\r\n                title: \"Client Created ðŸŽ‰\",\r\n                message: `Client <b>${frm.doc.client_created}</b> created successfully.`,\r\n                indicator: \"green\",\r\n                primary_action: {\r\n                    label: \"Open Client\",\r\n                    \r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    discount_amount: calculate_totals,\r\n    tax_amount: calculate_totals\r\n});\r\n\r\n\r\n/* =========================================================\r\n   ðŸ“¦ QUOTATION ITEM CHILD TABLE\r\n========================================================= */\r\n\r\nfrappe.ui.form.on(\"Quotation Item\", {\r\n    qty: calculate_row,\r\n    rate: calculate_row,\r\n    table_tgfh_remove(frm) {\r\n        calculate_totals(frm);\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Client Master",
  "enabled": 1,
  "modified": "2026-01-14 12:34:06.690506",
  "module": "CRM-Go-To",
  "name": "Performance UI",
  "script": "frappe.ui.form.on(\"Client Master\", {\r\n    refresh(frm) {\r\n        if (frm.doc.health_status === \"Critical\") {\r\n            frm.dashboard.set_headline_alert(\r\n                \"Client Health Critical âš \",\r\n                \"red\"\r\n            );\r\n        }\r\n        if (frm.doc.health_status === \"At Risk\") {\r\n            frm.dashboard.set_headline_alert(\r\n                \"Client Needs Attention\",\r\n                \"orange\"\r\n            );\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 }
]